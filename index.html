<html>
  <head>
    <title>VR Haunted Vending Hall</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.7/dist/aframe-environment-component.min.js"></script>
  </head>

  <body>
    <!-- Musique de Stranger Things -->
    <audio id="stranger-things-music" autoplay loop>
      <source src="asset/Kids.mp3" type="audio/mp3" />
    </audio>
    <a-scene
      background="color: black"
      fog="type: exponential; color: #0B1118; density: 0.1"
    >
      <a-assets>
        <a-asset-item id="map" src="./asset/map5.glb"></a-asset-item>
        <a-asset-item id="exitdoor" src="./asset/door1.glb"></a-asset-item>
        <a-asset-item id="portal" src="./asset/portal_final.glb"></a-asset-item>
        <a-asset-item id="door" src="./asset/door2.glb"></a-asset-item>
        <a-asset-item id="navmesh" src="./asset/navmesh.glb"></a-asset-item>
        <a-asset-item id="chair1" src="./asset/chair1.glb"></a-asset-item>
        <a-asset-item id="chair2" src="./asset/chair2.glb"></a-asset-item>
        <a-asset-item id="guirlande" src="./asset/guirlande.glb"></a-asset-item>
      </a-assets>

      <a-entity position="0 0 -4.5" rotation="0 270 0" scale="0.5 0.5 0.5">
        <!-- Map -->
        <a-entity gltf-model="#map" position="0 0 0" scale="1 1 1"></a-entity>

        <!-- Exit Easter Egg -->
        <a-entity
          gltf-model="#exitdoor"
          position="-11.9 0.530 -8.878"
          scale="0.7 0.7 0.7"
        ></a-entity>

        <!-- Chair -->
        <a-entity
          gltf-model="#chair1"
          position="1.4 3 5.8"
          scale="1 1 1"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear"
        ></a-entity>

        <a-entity
          gltf-model="#chair2"
          position="2.5 3.8 8.8"
          scale="1 1 1"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear"
        ></a-entity>

        <!-- Guirlande -->
        <a-entity
          gltf-model="#guirlande"
          position="2.7 3 -9.6"
          scale="0.75 0.75 0.75"
          rotation="-90 -90 0"
        ></a-entity>

        <a-box
          id="interactive-box"
          position="2.7 3 -9.6"
          scale="0.75 2 5"
          visible="false"
          class="clickable"
          event-set__click="_event: click; _target: #text-area; visible: true"
        ></a-box>

        <!-- Zone de texte cachée -->
        <a-entity
          id="text-area"
          visible="false"
          position=" 2.5 4.35 -11.7"
          rotation="0 -90 0"
        >
          <a-text
            value="C'est ici que la communication 
            vers l'autre monde se fait..."
            color="white"
            width="6"
            position="0 0 0"
          ></a-text>
        </a-entity>
        <a-entity
          gltf-model="#guirlande"
          position="2.7 3.8 -9.6"
          scale="0.75 0.75 0.75"
          rotation="-90 -90 0"
        ></a-entity>
        <a-entity
          gltf-model="#guirlande"
          position="2.7 2.2 -9.6"
          scale="0.75 0.75 0.75"
          rotation="-90 -90 0"
        ></a-entity>

        <!-- Doors -->
        <a-entity
          gltf-model="#door"
          rotation="0 90 0"
          position="7 0 2.8"
          scale="1 0.98 1"
        ></a-entity>
        <a-entity
          gltf-model="#door"
          rotation="0 -90 0"
          position="5 0 -2.8"
          scale="1 0.98 1"
        ></a-entity>
        <a-entity
          gltf-model="#door"
          rotation="0 90 0"
          position="1 0 2.8"
          scale="1 0.98 1"
        ></a-entity>
        <a-entity
          gltf-model="#door"
          rotation="0 -180 0"
          position="0.8 0 -4.7"
          scale="1 0.98 1"
        ></a-entity>
        <a-entity
          gltf-model="#door"
          rotation="0 -90 0"
          position="-7 0 -2.8"
          scale="1 0.98 1"
        ></a-entity>
        <a-entity
          gltf-model="#door"
          rotation="0 0 0"
          position="-6.8 0 4.7"
          scale="1 0.98 1"
        ></a-entity>

        <!-- Portal -->
        <a-entity
          gltf-model="#portal"
          rotation="0 0 0"
          position="-15 0 0"
          scale="1.25 1.25 1.25"
        >
          <a-light
            type="point"
            position="0.2 1.3 0"
            intensity="2"
            color="#ff4500"
            decay="2"
            distance="6"
          ></a-light>
        </a-entity>

        <!-- Lamp -->
        <a-entity
          id="flickering-neon"
          geometry="primitive: box; width: 2; height: 2; depth: 0.2"
          material="color: #ffffff; emissive: #ffffff; emissiveIntensity: 0.5"
          position="-6 5 0"
          rotation="-90 0 0"
        ></a-entity>

        <!-- Néon clignotant avec lumière -->
        <a-entity
          id="flickering-neon"
          geometry="primitive: box; width: 2; height: 2; depth: 0.2"
          material="color: #ffffff; emissive: #ffffff; emissiveIntensity: 0.5"
          position="-6 5 12"
          rotation="-90 0 0"
        >
          <a-light
            id="neon-light"
            type="point"
            position="0 1.3 0"
            intensity="0.5"
            color="#ffffff"
            distance="5"
          ></a-light>
        </a-entity>

        <!-- Navmesh -->
        <a-entity
          id="navmesh"
          gltf-model="#navmesh"
          nav-mesh
          visible="false"
          position="0 -0.7 0"
        ></a-entity>

        <!-- Square Lights -->
        <a-light
          type="point"
          position="-6 4.9 12"
          intensity="0.1"
          color="white"
        ></a-light>
        <a-light
          type="point"
          position="-6 4.9 0"
          intensity="0.1"
          color="white"
        ></a-light>
        <a-light
          type="point"
          position="-6 4.9 12"
          intensity="0.1"
          color="white"
        ></a-light>
      </a-entity>

      <!-- Ambient Light -->
      <a-light type="ambient" intensity="0.02"></a-light>

      <!-- Player -->
      <a-entity
        id="rig"
        movement-controls="enabled: true; constrainToNavMesh: true; speed: 0.2"
        dynamic-body
      >
        <a-entity
          camera
          position="0 1.6 0"
          look-controls="pointerLockEnabled: true"
        >
          <a-cursor></a-cursor
        ></a-entity>

        <!-- Main gauche -->
        <a-entity
          oculus-hand="hand: left"
          laser-controls="hand: right"
          raycaster="objects: .clickable"
          line="color: red; opacity: 0.5"
        ></a-entity>

        <!-- Main droite -->
        <a-entity
          oculus-hand="hand: right"
          laser-controls="hand: left"
          raycaster="objects: .clickable"
          line="color: red; opacity: 0.5"
        ></a-entity>
      </a-entity>
    </a-scene>

    <script>
      // Fonction pour faire clignoter aléatoirement le néon et la lumière
      const flickerNeon = () => {
        const neon = document.querySelector("#flickering-neon");
        const neonLight = document.querySelector("#neon-light");
        if (!neon || !neonLight) return;

        // Intensité aléatoire (0 = éteint, 1 = très lumineux)
        const intensity = Math.random() > 0.5 ? Math.random() : 0;

        // Appliquer l'intensité au néon et à la lumière
        neon.setAttribute("material", "emissiveIntensity", intensity);
        neonLight.setAttribute("intensity", intensity * 2);

        // Intervalle aléatoire pour le prochain clignotement (50ms à 500ms)
        const nextFlicker = Math.random() * 450 + 50;
        setTimeout(flickerNeon, nextFlicker);
      };

      flickerNeon(); // Démarre le clignotement

      // Interaction de la boîte qui ouvre le texte
      const box = document.querySelector("#interactive-box");
      const textArea = document.querySelector("#text-area");

      box.addEventListener("click", () => {
        console.log("Clic détecté sur la boîte");
        // Toggle la visibilité du texte
        const isVisible = textArea.getAttribute("visible");
        textArea.setAttribute("visible", !isVisible);
      });
    </script>
  </body>
</html>
